{"changed":true,"filter":false,"title":"invitations.rb","tooltip":"/app/admin/invitations.rb","value":"ActiveAdmin.register Invitation do\n# See permitted parameters documentation:\n# https://github.com/activeadmin/activeadmin/blob/master/docs/2-resource-customization.md#setting-up-strong-parameters\n#\n# permit_params :list, :of, :attributes, :on, :model\n#\n# or\n#\n# permit_params do\n#   permitted = [:permitted, :attributes]\n#   permitted << :other if params[:action] == 'create' && current_user.admin?\n#   permitted\n# end\n@name = \"Invitación\"\n\nmenu false\norderable\n\nactions :index, :show, :new, :create, :update, :edit\n\nbreadcrumb do\n    [\n      link_to('Invitaciones', '/admin/invitations')\n    ]\nend\n\nconfig.action_items.delete_if {|item| item.name == :edit && item.display_on?(:show) }\n\ncontroller do\n  def permitted_params\n    params.permit!\n  end\n  def update\n    update! do |format, invitation|\n      format.html { redirect_to edit_admin_invitation_path(resource) }\n      format.json { render json: edit_admin_invitation_path(resource) }\n    end\n    \n  end\n  \n  \n  def quick_events\n    \n    # First, instantiate the SDK with your API credentials, domain, and required parameters for example.\n    #mg_client = Mailgun::Client.new(ENV['MAILGUN_API_KEY'])\n    #mg_events = Mailgun::Events.new(mg_client, ENV['MAILGUN_DOMAIN'])\n    \n    #result = mg_events.get({'limit' => 25,\n                            'recipient' => 'mdbaez@hotmail.com.ar'})\n                            \n    #@results = result.to_h['items']\n    \n    # Want more results?\n    #result = mg_events.next\n    \n    # Go backwards?\n    #result = mg_events.previous\n  end\n  \n  def quick_whatsapp\n      @invitation = Invitation.find(params[:id])\n      @guests = @invitation.guests\n      \n      render layout: false \n  end\n  \n  def quick_send\n      @invitation = Invitation.find(params[:id])\n      @guests = @invitation.guests\n      \n      render layout: false \n  end\n  \n  def quick_send_mails\n      #@invitation = Invitation.find(params[:id])\n      #@guests = @invitation.guests\n      #render layout: false\n      #UserNotifier.send_signup_email(@guest).deliver\n      \n      \n      @guests = params[:guests]\n      @invitation = Invitation.find(params[:id])\n      @invitados = @invitation.guests.collect{|t| t.name}.join('<br>').html_safe\n      #@sent = {}\n      @sent = ''\n      @guests.each do |key, value|\n        @g = Guest.find(key)\n\n        \n      mailer_response = InvitationMailer.send_invitation_email(@g, @invitados).deliver_now\n      \n      sent_email = SentEmail.new\n      sent_email.guest_id = @g.id\n      sent_email.invitation_id = @g.invitation_id\n      sent_email.message_id = mailer_response.message_id\n      sent_email.status = mailer_response.message_id\n      sent_email.recipient = @g.email\n      sent_email.save\n      @sent = @sent + '\\n'  + @g.name\n      #@sent.store(@g.email,result)\n      end\n      render 'quick_send_response.js', layout: false, invitation: @invitation, sent: @sent\n      #render @html\n      #redirect_to admin_invitation_path(params[:id])\n\n  end\n  def quick_sort\n      @invitation = Invitation.find(params[:id])\n      render layout: false\n  end\n  \n  def quick_remove\n      @invitation = Invitation.find(params[:id])\n      @guest = Guest.find(params[:guest_id]).destroy\n      redirect_to admin_invitation_path(@invitation) \n  end\n  def quick_add\n      @invitation = Invitation.find(params[:id])\n      @guest = Guest.new()\n      @guest.invitation = @invitation\n      render layout: false\n  end\n  \n  def quick_create\n      @invitation = Invitation.find(params[:id])\n      @guest = Guest.new(permitted_params[:guest])\n      @guest.invitation = @invitation\n      @guest.save\n      render 'quick_response.js', layout: false, invitation: @invitation, guest: @guest\n  end\n  \nend\n\n\naction_item only: :show do\n  link_to 'Enviar por Email', admin_invitation_quick_send_path, class: 'fancybox', data: { 'fancybox-type' => 'ajax' }\nend\n\naction_item :view, only: :show do\n  link_to 'Enviar por Whatsapp', admin_invitation_quick_whatsapp_path, class: 'fancybox', data: { 'fancybox-type' => 'ajax' }\nend\naction_item :view, only: :show do\n  link_to 'Compartir en Facebook', \"https://www.giypablo.com/invitations/\" + resource.id.to_s, class: 'facebook-share'\nend\n\nindex :title => 'Invitaciones' do\n    column \"Título\" do |invitation|\n        invitation.title\n    end\n    column \"Invitados\" do |invitation|\n        invitation.guests.collect{|t| t.name}.join(', ').html_safe\n    end\n    \n    column \"Cantidad de Invitados\", :sortable do |invitation|\n        invitation.guests.count\n    end\n    column do |invitation|\n        link_to \"Editar\", admin_invitation_path(invitation)\n    end\n    \nend\n\nshow do |invitation|\n  team = Invitation.find(params[:id])\n\n  panel \"Invitación\" do\n    attributes_table_for team do\n      row \"Título\" do\n        best_in_place invitation, :title, as: :input, url: [:admin, invitation], :place_holder => \"Clic para editar\"\n      end\n    end\n  end\n\n  panel \"Invitados\" do\n        div class: 'button-row' do\n          link_to 'Agregar Invitado', admin_guest_quick_add_path, class: 'fancybox button', data: { 'fancybox-type' => 'ajax' }\n        end\n        \n        table_for invitation.guests, {:class => 'index_table'} do |guests|\n            column \"Nombre del Invitado\" do |guest|\n                best_in_place guest, :name, as: :input, url: [:admin, invitation,guest], :place_holder => \"Clic para agregar\",:required => true\n            end \n            column \"Email\" do |guest|\n                best_in_place guest, :email, as: :input, url: [:admin, invitation,guest], :place_holder => \"Clic para agregar\"\n            end\n            column \"Teléfono móvil\" do |guest|\n                best_in_place guest, :phone, as: :input, url: [:admin, invitation,guest], :place_holder => \"Clic para agregar\"\n            end\n            column max_width: \"200px\", min_width: \"100px\" do |guest|\n                link_to \"Delete\", admin_guest_quick_remove_path(resource.id,guest.id), data: { confirm: 'Quitar al Invitado de la lista?' }, :class => \"member_link delete_link\"\n            end\n        end\n\n      end\n\n  \n\n    # renders app/views/admin/posts/_some_partial.html.erb\n    # render 'send', { invitation: invitation }\n\nend\n#sidebar \"Estado de Envío\", only: :edit do\n#  render 'status', { invitation: invitation }\n#end\nform :title => 'Editar Invitación' do |f|\n    \n    f.semantic_errors # shows errors on :base\n    f.inputs do\n      f.input :title , label: \"Título de la Invitación\"\n      f.has_many :guests, sortable: :sort_order, heading: false, allow_destroy: true, new_record: 'Agregar Invitado' do |a|\n        a.input :name, label: \"Nombre del Invitado\"\n        a.input :email, label: \"Email del Invitado\"\n        a.input :phone, label: \"Teléfono movil del Invitado\"\n      end\n    end\n    \n    f.actions\n    #image_tag @invitation.cover_photo_url(:thumbnail).to_s, width: 300, class: \"img-thumbnail file-upload-preview\", id: \"preview-cover-photo\"\n    \n  end\nend\n","undoManager":{"mark":35,"position":39,"stack":[[{"start":{"row":14,"column":0},"end":{"row":15,"column":0},"action":"remove","lines":["menu false",""],"id":199},{"start":{"row":14,"column":0},"end":{"row":15,"column":0},"action":"insert","lines":["",""]}],[{"start":{"row":16,"column":9},"end":{"row":17,"column":0},"action":"insert","lines":["",""],"id":200}],[{"start":{"row":18,"column":52},"end":{"row":19,"column":0},"action":"insert","lines":["",""],"id":201}],[{"start":{"row":24,"column":3},"end":{"row":25,"column":0},"action":"insert","lines":["",""],"id":202}],[{"start":{"row":39,"column":2},"end":{"row":44,"column":5},"action":"remove","lines":["def lock","    lock! do |format, invitation|","      ","      ","    end","  end"],"id":203}],[{"start":{"row":52,"column":25},"end":{"row":53,"column":0},"action":"insert","lines":["",""],"id":204},{"start":{"row":53,"column":0},"end":{"row":53,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":53,"column":4},"end":{"row":54,"column":0},"action":"insert","lines":["",""],"id":205},{"start":{"row":54,"column":0},"end":{"row":54,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":54,"column":4},"end":{"row":70,"column":27},"action":"insert","lines":["# First, instantiate the SDK with your API credentials, domain, and required parameters for example.","mg_client = Mailgun::Client.new(\"your-api-key\")","mg_events = Mailgun::Events.new(mg_client, \"your-domain\")","","result = mg_events.get({'limit' => 25,","                        'recipient' => 'joe@example.com'})","","result.to_h['items'].each do | item |","    # outputs \"Delivered - 20140509184016.12571.48844@example.com\"","    puts \"#{item['event']} - #{item['message']['headers']['message-id']}\"","end","","# Want more results?","result = mg_events.next","","# Go backwards?","result = mg_events.previous"],"id":206}],[{"start":{"row":55,"column":0},"end":{"row":55,"column":2},"action":"insert","lines":["  "],"id":207},{"start":{"row":56,"column":0},"end":{"row":56,"column":2},"action":"insert","lines":["  "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":2},"action":"insert","lines":["  "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":2},"action":"insert","lines":["  "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":2},"action":"insert","lines":["  "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":2},"action":"insert","lines":["  "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":2},"action":"insert","lines":["  "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":2},"action":"insert","lines":["  "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":2},"action":"insert","lines":["  "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":2},"action":"insert","lines":["  "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":2},"action":"insert","lines":["  "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":2},"action":"insert","lines":["  "]},{"start":{"row":67,"column":0},"end":{"row":67,"column":2},"action":"insert","lines":["  "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":2},"action":"insert","lines":["  "]},{"start":{"row":69,"column":0},"end":{"row":69,"column":2},"action":"insert","lines":["  "]},{"start":{"row":70,"column":0},"end":{"row":70,"column":2},"action":"insert","lines":["  "]}],[{"start":{"row":55,"column":0},"end":{"row":55,"column":2},"action":"insert","lines":["  "],"id":208},{"start":{"row":56,"column":0},"end":{"row":56,"column":2},"action":"insert","lines":["  "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":2},"action":"insert","lines":["  "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":2},"action":"insert","lines":["  "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":2},"action":"insert","lines":["  "]},{"start":{"row":60,"column":0},"end":{"row":60,"column":2},"action":"insert","lines":["  "]},{"start":{"row":61,"column":0},"end":{"row":61,"column":2},"action":"insert","lines":["  "]},{"start":{"row":62,"column":0},"end":{"row":62,"column":2},"action":"insert","lines":["  "]},{"start":{"row":63,"column":0},"end":{"row":63,"column":2},"action":"insert","lines":["  "]},{"start":{"row":64,"column":0},"end":{"row":64,"column":2},"action":"insert","lines":["  "]},{"start":{"row":65,"column":0},"end":{"row":65,"column":2},"action":"insert","lines":["  "]},{"start":{"row":66,"column":0},"end":{"row":66,"column":2},"action":"insert","lines":["  "]},{"start":{"row":67,"column":0},"end":{"row":67,"column":2},"action":"insert","lines":["  "]},{"start":{"row":68,"column":0},"end":{"row":68,"column":2},"action":"insert","lines":["  "]},{"start":{"row":69,"column":0},"end":{"row":69,"column":2},"action":"insert","lines":["  "]},{"start":{"row":70,"column":0},"end":{"row":70,"column":2},"action":"insert","lines":["  "]}],[{"start":{"row":56,"column":47},"end":{"row":56,"column":60},"action":"remove","lines":["\"your-domain\""],"id":209},{"start":{"row":56,"column":47},"end":{"row":56,"column":68},"action":"insert","lines":["ENV['MAILGUN_DOMAIN']"]}],[{"start":{"row":55,"column":36},"end":{"row":55,"column":50},"action":"remove","lines":["\"your-api-key\""],"id":210},{"start":{"row":55,"column":36},"end":{"row":55,"column":58},"action":"insert","lines":["ENV['MAILGUN_API_KEY']"]}],[{"start":{"row":59,"column":44},"end":{"row":59,"column":59},"action":"remove","lines":["joe@example.com"],"id":211},{"start":{"row":59,"column":44},"end":{"row":59,"column":66},"action":"insert","lines":["\tmdbaez@hotmail.com.ar"]}],[{"start":{"row":42,"column":4},"end":{"row":46,"column":34},"action":"remove","lines":["# First, instantiate the Mailgun Client with your API key","    mg_client = Mailgun::Client.new ENV['MAILGUN_API_KEY']","    ","    # Define the domain you wish to query","    domain = ENV['MAILGUN_DOMAIN']"],"id":212}],[{"start":{"row":42,"column":4},"end":{"row":43,"column":4},"action":"remove","lines":["","    "],"id":213}],[{"start":{"row":54,"column":44},"end":{"row":54,"column":45},"action":"remove","lines":["\t"],"id":214}],[{"start":{"row":43,"column":4},"end":{"row":47,"column":25},"action":"remove","lines":["# Issue the get request","    @results = mg_client.get(\"#{domain}/events\")","    @results = @results.to_h","    #render json: result.to_h","    render layout: false "],"id":215},{"start":{"row":43,"column":2},"end":{"row":43,"column":4},"action":"remove","lines":["  "]},{"start":{"row":43,"column":0},"end":{"row":43,"column":2},"action":"remove","lines":["  "]},{"start":{"row":42,"column":4},"end":{"row":43,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":61,"column":0},"end":{"row":61,"column":2},"action":"insert","lines":["  "],"id":216}],[{"start":{"row":61,"column":2},"end":{"row":61,"column":4},"action":"insert","lines":["  "],"id":217}],[{"start":{"row":61,"column":4},"end":{"row":61,"column":24},"action":"insert","lines":["render layout: false"],"id":218}],[{"start":{"row":50,"column":4},"end":{"row":50,"column":5},"action":"insert","lines":["@"],"id":219},{"start":{"row":50,"column":5},"end":{"row":50,"column":6},"action":"insert","lines":["r"]},{"start":{"row":50,"column":6},"end":{"row":50,"column":7},"action":"insert","lines":["e"]}],[{"start":{"row":50,"column":7},"end":{"row":50,"column":8},"action":"insert","lines":["e"],"id":220}],[{"start":{"row":50,"column":7},"end":{"row":50,"column":8},"action":"remove","lines":["e"],"id":221}],[{"start":{"row":50,"column":7},"end":{"row":50,"column":8},"action":"insert","lines":["s"],"id":222},{"start":{"row":50,"column":8},"end":{"row":50,"column":9},"action":"insert","lines":["u"]},{"start":{"row":50,"column":9},"end":{"row":50,"column":10},"action":"insert","lines":["l"]},{"start":{"row":50,"column":10},"end":{"row":50,"column":11},"action":"insert","lines":["t"]},{"start":{"row":50,"column":11},"end":{"row":50,"column":12},"action":"insert","lines":["s"]}],[{"start":{"row":50,"column":12},"end":{"row":50,"column":13},"action":"insert","lines":[" "],"id":223},{"start":{"row":50,"column":13},"end":{"row":50,"column":14},"action":"insert","lines":["="]}],[{"start":{"row":50,"column":14},"end":{"row":50,"column":15},"action":"insert","lines":[" "],"id":224}],[{"start":{"row":50,"column":15},"end":{"row":50,"column":35},"action":"insert","lines":["result.to_h['items']"],"id":225}],[{"start":{"row":50,"column":35},"end":{"row":51,"column":0},"action":"insert","lines":["",""],"id":226},{"start":{"row":51,"column":0},"end":{"row":51,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":52,"column":4},"end":{"row":55,"column":7},"action":"remove","lines":["result.to_h['items'].each do | item |","        # outputs \"Delivered - 20140509184016.12571.48844@example.com\"","        puts \"#{item['event']} - #{item['message']['headers']['message-id']}\"","    end"],"id":227}],[{"start":{"row":52,"column":2},"end":{"row":52,"column":4},"action":"remove","lines":["  "],"id":228},{"start":{"row":52,"column":0},"end":{"row":52,"column":2},"action":"remove","lines":["  "]},{"start":{"row":51,"column":4},"end":{"row":52,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":51,"column":2},"end":{"row":51,"column":4},"action":"remove","lines":["  "],"id":229},{"start":{"row":51,"column":0},"end":{"row":51,"column":2},"action":"remove","lines":["  "]},{"start":{"row":50,"column":35},"end":{"row":51,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":42,"column":4},"end":{"row":43,"column":4},"action":"remove","lines":["","    "],"id":230}],[{"start":{"row":52,"column":4},"end":{"row":52,"column":5},"action":"insert","lines":["#"],"id":233}],[{"start":{"row":55,"column":4},"end":{"row":55,"column":5},"action":"insert","lines":["#"],"id":234}],[{"start":{"row":56,"column":0},"end":{"row":57,"column":0},"action":"remove","lines":["    render layout: false",""],"id":235}],[{"start":{"row":48,"column":68},"end":{"row":49,"column":0},"action":"insert","lines":["",""],"id":236},{"start":{"row":49,"column":0},"end":{"row":49,"column":28},"action":"insert","lines":["                            "]}],[{"start":{"row":50,"column":4},"end":{"row":50,"column":5},"action":"insert","lines":["#"],"id":237}],[{"start":{"row":47,"column":4},"end":{"row":47,"column":5},"action":"insert","lines":["#"],"id":238}],[{"start":{"row":45,"column":4},"end":{"row":45,"column":5},"action":"insert","lines":["#"],"id":239}],[{"start":{"row":44,"column":4},"end":{"row":44,"column":5},"action":"insert","lines":["#"],"id":240}]]},"ace":{"folds":[],"scrolltop":600,"scrollleft":0,"selection":{"start":{"row":44,"column":5},"end":{"row":44,"column":5},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1537920099423}